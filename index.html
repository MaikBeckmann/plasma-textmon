<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Digitize your TextMon :D</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Digitize your TextMon :D"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-02-13 00:22:43 CET"/>
<meta name="author" content="Maik Beckmann &amp;lt;beckmann.maik@googlemail.com&amp;gt;"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org-mode.css"/>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Digitize your TextMon :D</h1>




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction</a></li>
<li><a href="#sec-2">2 Hello Javascript</a>
<ul>
<li><a href="#sec-2-1">2.1 Install a Javascript interpreter</a></li>
<li><a href="#sec-2-2">2.2 Not Ubuntu</a>
<ul>
<li><a href="#sec-2-2-1">2.2.1 js</a></li>
<li><a href="#sec-2-2-2">2.2.2 v8</a></li>
<li><a href="#sec-2-2-3">2.2.3 rhino</a></li>
</ul>
</li>
<li><a href="#sec-2-3">2.3 Hello World</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Hello Plasma</a>
<ul>
<li><a href="#sec-3-1">3.1 And there was metadata</a></li>
<li><a href="#sec-3-2">3.2 plasmapkg and life ain't easy</a></li>
<li><a href="#sec-3-3">3.3 Give yourself a treat: Good error messages</a></li>
</ul>
</li>
<li><a href="#sec-4">4 Hello?</a>
<ul>
<li><a href="#sec-4-1">4.1 Getting more than one shot</a></li>
<li><a href="#sec-4-2">4.2 A sink with a slot</a></li>
<li><a href="#sec-4-3">4.3 Connecting the slot to a source</a></li>
<li><a href="#sec-4-4">4.4 Exploring a data source</a></li>
</ul>
</li>
<li><a href="#sec-5">5 The <i>systemmonitor</i> date engine</a>
<ul>
<li><a href="#sec-5-1">5.1 CPU load</a></li>
<li><a href="#sec-5-2">5.2 Application memory</a></li>
<li><a href="#sec-5-3">5.3 Wlan</a>
<ul>
<li><a href="#sec-5-3-1">5.3.1 Down rate</a></li>
<li><a href="#sec-5-3-2">5.3.2 Up rate</a></li>
<li><a href="#sec-5-3-3">5.3.3 Joined data</a></li>
</ul>
</li>
<li><a href="#sec-5-4">5.4 Harddisk</a>
<ul>
<li><a href="#sec-5-4-1">5.4.1 Read rate</a></li>
<li><a href="#sec-5-4-2">5.4.2 Write rate</a></li>
<li><a href="#sec-5-4-3">5.4.3 Joined data</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-6">6 UI</a>
<ul>
<li><a href="#sec-6-1">6.1 Hello plasmoid</a></li>
<li><a href="#sec-6-2">6.2 Hello label</a></li>
<li><a href="#sec-6-3">6.3 Hello layout</a></li>
<li><a href="#sec-6-4">6.4 More labels!</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">

<p>This guide aims to show you how to code a simple sytem minitor plasma applet in
Javascript.
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Hello Javascript</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Install a Javascript interpreter</h3>
<div class="outline-text-3" id="text-2-1">

</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Not Ubuntu</h3>
<div class="outline-text-3" id="text-2-2">


</div>

<div id="outline-container-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> js</h4>
<div class="outline-text-4" id="text-2-2-1">

<p>This is Mozilla's command line Javascript interpreter.  It's what I'll be using
throughout this document, like
</p><pre class="example">
% js foobar.js
</pre>


<p>
The package which contains this executable
</p><dl>
<dt>js</dt><dd>for ArchLinux, OpenSUSE and Fedora
</dd>
<dt>spidermonkey-bin</dt><dd>for Debian
</dd>
</dl>


<p>
It is <span style="text-decoration:underline;">not</span> available on <b>Ubuntu</b>.  You have to use one of the two following.
</p>
</div>

</div>

<div id="outline-container-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> v8</h4>
<div class="outline-text-4" id="text-2-2-2">

<p>The <code>v8</code> package contains the <code>d8</code> Javscript interpreter.  When this documention says
</p><pre class="example">
% js foobar.js
</pre>

<p>then you can use
</p><pre class="example">
% d8 foobar.js
</pre>

<p>instead.
</p>
</div>

</div>

<div id="outline-container-2-2-3" class="outline-4">
<h4 id="sec-2-2-3"><span class="section-number-4">2.2.3</span> rhino</h4>
<div class="outline-text-4" id="text-2-2-3">

<p>This is an Java implementation.  It will take forever to startup the first time
it runs, but after that it's ok.  When this documention says
</p><pre class="example">
% js foobar.js
</pre>

<p>then you can use
</p><pre class="example">
% rhino foobar.js
</pre>

<p>instead.
</p>
<p>
Note: Only about Ubuntu I know for certain that it's <code>rhino</code> package includes
the <code>/usr/bin/rhino</code> shell script.  On Archlinux you'd have to do
</p><pre class="example">
% java -jar /usr/share/java/js.jar foobar.js
</pre>


</div>
</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Hello World</h3>
<div class="outline-text-3" id="text-2-3">

<p>Open your favorite editor and create the file <code>foobar.js</code> with the content
</p>


<pre class="src src-js">print(<span class="org-string">"Hello World!"</span>);
</pre>

<p>
and run it in a shell
</p><pre class="example">
% js foobar.js
Hello World!
</pre>


</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Hello Plasma</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> And there was metadata</h3>
<div class="outline-text-3" id="text-3-1">

<p>We aim to have plasma run our little world script.
</p>


<pre class="src src-js">print(<span class="org-string">"hello world"</span>);
</pre>

<p>
For this we have to create a plasma package.  A package consists of its
content, our Javascript file, and meta data that describes this content and its
role.  The file tree of the simplest possible package looks like this
</p><pre class="example">
hello_world
├── contents
│   └── main.js
└── metadata.desktop
</pre>

<p>The simplest possible and barely working meta data is
</p>


<pre class="src src-conf">[<span class="org-type">Desktop Entry</span>]
<span class="org-variable-name">Type</span>=Service
<span class="org-variable-name">X-Plasma-API</span>=javascript
<span class="org-variable-name">X-Plasma-MainScript</span>=main.js
</pre>

<p>
Now change to the directory <code>hello_world</code>, which contains the <code>metadata.desktop</code>
file, and execute
</p><pre class="example">
plasmoidviewer .
</pre>

<p>An empty default applet appears, since we haven't done anything to the user
interface yet, and the text
</p><pre class="example">
hello world
</pre>

<p>appears in the shell where we started plasmoidviewer
</p>
<div id="fig-empty_default" class="figure">
<p><img src="images/empty_default_applet.png"  alt="images/empty_default_applet.png" /></p>
<p>Empty default applet</p>
</div>

</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> plasmapkg and life ain't easy</h3>
<div class="outline-text-3" id="text-3-2">

<p>To make our applet be usable for plasma we have to install it.  We'll install
it into our user directory
</p><pre class="example">
% echo $(kde4-config --localprefix)
</pre>

<p>which will be something like <code>/home/YOU/.kde</code> or <code>/home/YOU/.kde4</code>, just paste
it into the shel and see for yourself.  The follwing command does the
installation
</p><pre class="example">
% plasmapkg -i .
</pre>

<p>But it won't work.  It fails with
</p><pre class="example">
plasmapkg(24248)/libplasma Plasma::Package::installPackage: Package plugin name not specified
Installation of /home/maik/.../hello_world failed.
</pre>

<p>Okay, lets add a name.  The name is provided by <code>X-KDE-PluginInfo-Name</code>
</p>


<pre class="src src-conf">[<span class="org-type">Desktop Entry</span>]
<span class="org-variable-name">Type</span>=Service

<span class="org-variable-name">X-KDE-PluginInfo-Name</span>=HelloFoobar
<span class="org-variable-name">X-Plasma-API</span>=javascript
<span class="org-variable-name">X-Plasma-MainScript</span>=main.js
</pre>

<p>
Lets try again
</p><pre class="example">
% plasmapkg -i .
Successfully installed /home/maik/Projekte/kde/plasmoids/javascript/textmon_tut/hello_world
</pre>

<p>Yay!  Now we want to run it.  Plasmoidviewer can to do that as well.  Instead
of giving a path to it, we give the name we've put into the meta data
</p><pre class="example">
% plasmoidviewer HelloFoobar
</pre>

<p>But it won't work, again.  You get
</p>
<div id="fig-missing_servicetypes" class="figure">
<p><img src="images/missing_servicetypes.png" width="250" alt="images/missing_servicetypes.png" /></p>
<p>Missing X-KDE-ServiceTypes</p>
</div>
<p>
BUMMER!  But wait, there is more fail to come.  Before I explain what is
missing, lets try to get rid if the faulty installation.  You generally can
remove plasma components with
</p><pre class="example">
% plasmapkg -r PACKAGENAME
</pre>

<p>But
</p><pre class="example">
% plasmapkg -r HelloFoobar
</pre>

<p>results in
</p><pre class="example">
Plugin HelloFoobar is not installed.
</pre>

<p>WAT?  That is clearly not correct.  It is a bug in plasmapkg that I'll report
ASAP, I promise.  I the mean time do this
</p><pre class="example">
% rm $(kde4-config --localprefix)/share/kde4/services/plasma-applet-HelloFoobar.desktop
% rm $(kde4-config --localprefix)/share/apps/plasma/plasmoids/HelloFoobar/ -r
</pre>


<p>
What we have to add is the role this <i>Service</i> named <i>HelloFoobar</i> plays.  It's
a plasma applet:
</p>


<pre class="src src-conf">[<span class="org-type">Desktop Entry</span>]
<span class="org-variable-name">Type</span>=Service

<span class="org-variable-name">X-KDE-PluginInfo-Name</span>=HelloFoobar
<span class="org-variable-name">X-KDE-ServiceTypes</span>=Plasma/Applet

<span class="org-variable-name">X-Plasma-API</span>=javascript
<span class="org-variable-name">X-Plasma-MainScript</span>=main.js
</pre>

<p>
No we can not only
</p><pre class="example">
% plasmapkg -i .
Successfully installed /home/maik/Projekte/kde/plasmoids/javascript/textmon_tut/hello_world
</pre>

<p>but also
</p><pre class="example">
% plasmoidviewer HelloFoobar
hello world
</pre>

<p>as well as
</p><pre class="example">
% plasmapkg -r HelloFoobar
Successfully removed HelloFoobar
</pre>

<p>Yay :D
</p>
<p>
Since we have a package that plasmapkg can chew on without choking I suggest
you play a bit with the options it provides.  We already saw how to install
</p><pre class="example">
% plasmapkg -i /path/to/package/dir/
% plasmapkg -i /path/to/package.plasmoid
</pre>

<p>where we used the first version with
</p><pre class="example">
% plasmapkg -i .
</pre>

<p>We also, though unsuccessfully, used the command line to remove a package
</p><pre class="example">
% plasmapkg -r PACKAGENAME
% plasmapkg -r /path/to/package/dir/
</pre>

<p>The second one reads the name of the package to remove from the
<code>metadata.desktop</code> file in the directory it was given the path to.  That's why
</p><pre class="example">
% plasmapkg -r .
</pre>

<p>just reverts the things done by <code>plasmapkg -i</code>.  Well, once the bug mentioned
above is fixed :P.  Finally the plasmapkg command you'll be using most of the
time is that to upgrading an existing package
</p><pre class="example">
% plasmapkg -u /path/to/package/dir/
% plasmapkg -u /path/to/package.plasmoid
</pre>

<p>This actually removes the package and installs it again.  For example
</p><pre class="example">
% plasmapkg -u .
</pre>

<p>and
</p><pre class="example">
% plasmapkg -r .
% plasmapkg -i .
</pre>

<p>do the very same things.
</p>
</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Give yourself a treat: Good error messages</h3>
<div class="outline-text-3" id="text-3-3">

<p>Consider this code
</p>


<pre class="src src-js">array = [1, 2, 3];
</pre>

<p>
and break it
<code>foobar.js</code>
</p>


<pre class="src src-js">array = [1, 2 3];
</pre>

<p>
Put that into our main.js and see what plasma has to say
</p><pre class="example">
% plasmoidviwer .
</pre>

<p>We get this:
</p>
<div id="fig-missing_servicetypes" class="figure">
<p><img src="images/syntax_error.png" width="250" alt="images/syntax_error.png" /></p>
<p>Syntax Error: Parse Error.  This means: dunno!</p>
</div>
<p>
Well ok, parsing a programming language is hard.  I'm sure they done as good as
anybody can ask for, right?  Lets see what the contenders have to say. Here
Mozilla's js
</p><pre class="example">
% js main.js
main.js:1: SyntaxError: missing ] after element list:
main.js:1: array = [1, 2 3];
main.js:1: ..............^
</pre>

<p>or Google's v8 (its command line debugger is called d8)
 :% d8 main.js
</p><pre class="example">
main.js:1: SyntaxError: Unexpected number
array = [1, 2 3];
              ^
SyntaxError: Unexpected number
</pre>

<p>or rhino, as well done by Mozilla
</p><pre class="example">
% rhino main.js
js: "main.js", line 1: missing ] after element list
js: array = [1, 2 3];
js: ...............^
</pre>

<p>Rhino is off by one dot, but still: wow!
</p>
<p>
A missing comma, brace and bracet is an frequent coding error.  QtScript will
give you the line number, that's it.  If you have no idea what the heck it's
problem is, do yourself a favor by pasting the code in question into file and
have one of the above Javascript interpreters a run at it.  They of cause won't
be able to run it, but they'll find the syntax error with a <span style="text-decoration:underline;">sweet</span> error
message.
</p>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Hello?</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Getting more than one shot</h3>
<div class="outline-text-3" id="text-4-1">

<p>Our script is run exactly once!  To get more than this single run, we have to
convince plasma to give us additional cpu cycles.  this is done by defining a
data sink and connecting it to a source.
</p>
</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> A sink with a slot</h3>
<div class="outline-text-3" id="text-4-2">

<p>An object acts as the sink and a function as the slot that connects the source
to the sink
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"ping"</span>);
  }
};
</pre>

<p>
The name of the sink Object can be anything
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">CatDog</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"ping"</span>);
  }
};
</pre>

<p>
The name of the slot function however is to be <code>dataUpdated</code>.  The function
always receives two parameters.  We'll dicuss their content in a bit.
</p>
</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Connecting the slot to a source</h3>
<div class="outline-text-3" id="text-4-3">

<p>A plasma engine provides sources.  They're connected to via their
<code>connectSource</code> method.  The arguments this method takes are the name of the
source, the sink object and the desired interval length in which sink's
<code>dataUpdated</code> slot should be called.
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"SourcesServingEngine"</span>)
<span class="org-keyword">var</span> <span class="org-variable-name">intervalInMilliSeconds</span> = 1000;  <span class="org-comment-delimiter">// </span><span class="org-comment">one second</span>
engine.connectSource(<span class="org-string">"SourceOfInterest"</span>, sink, intervalInMilliSeconds);
</pre>

<p>
This code has a flaw.  The connection might fail of
</p><ul>
<li>the source doesn't exist
</li>
<li>the sink object doesn't define the <code>dataUpdated</code> slot.
</li>
</ul>

<p>This flowing version doesn't really handle these situation, but at least tells
us about it.
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"SourcesServingEngine"</span>)
<span class="org-keyword">var</span> <span class="org-variable-name">intervalInMilliSeconds</span> = 1000;  <span class="org-comment-delimiter">// </span><span class="org-comment">one second</span>
<span class="org-keyword">if</span> (! engine.connectSource(<span class="org-string">"SourceOfInterest"</span>, sink, intervalInMilliSeconds) ) {
  print(<span class="org-string">"connection attempt to SourceOfInterest in SourcesServingEngine failed D:"</span>);
}
</pre>


<p>
To actually find a data source and a source it provides we gonna use
</p><pre class="example">
% plasmaengineexplorer
</pre>


<div id="fig-plasmaengineexplorer" class="figure">
<p><img src="images/plasmaengineexplorer.png"  alt="images/plasmaengineexplorer.png" /></p>
<p>Plasma engine explorer</p>
</div>
<p>
In image <a href="#fig-plasmaengineexplorer">plasmaengineexplorer</a> the source <i>Local</i> of the <i>time</i> data
engine is expanded.  This code uses it
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"ping"</span>);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"time"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"Local"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<p>
and results in
</p><pre class="example">
ping
connection established
main.js ends here
ping
ping
ping
</pre>


<p>
As you can see, connectSource calls the dataUpdated slot.  So make sure that
it's already there.  If not
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"time"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"Local"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

sink.dataUpdated = <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
  print(<span class="org-string">"ping"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<p>
we'll get
</p><pre class="example">
% plasmoidviewer .
connection attempt failed
main.js ends here
%
</pre>


</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Exploring a data source</h3>
<div class="outline-text-3" id="text-4-4">

<p>So far it is only confirmed that <code>dataUpdated</code> was called back.  Now we take a
look at the value of the parameters it is called with by the data engine.
</p>
<p>
First the <code>name</code>.  This code for the sink section
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(name);
  }
};
</pre>

<p>
results in
</p><pre class="example">
Local
connection established
main.js ends here
Local
Local
...
</pre>

<p>This is the same name we used with <code>connectSource</code>.  This becomes important
when we subscribe to more than one data source.
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(name);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"time"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"Local"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection to 'Local' in 'time' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to 'Local' in 'time' failed"</span>);
}
<span class="org-comment-delimiter">//</span>
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"Europe/London"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection to 'Europe/London' in 'time' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to 'Europe/London' in 'time' failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
 % plasmoidviewer .
Local
connection to 'Local' in 'time' established
Europe/London
connection to 'Europe/London' in 'time' established
main.js ends here
Local
Europe/London
Local
Europe/Londo
</pre>


<p>
Now the <code>data</code>.  We're using the version that only connects to <code>Local</code> in
<code>time</code> with this slot definition
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"===== data ====="</span>);
    <span class="org-keyword">for</span>(<span class="org-keyword">var</span> <span class="org-variable-name">k</span> <span class="org-keyword">in</span> data) {
      print(<span class="org-string">"key : "</span> + k);
      print(<span class="org-string">"data[key] : "</span> + data[k]);
      print(<span class="org-string">"typeof data[key] : "</span> + <span class="org-keyword">typeof</span> data[k]);
      print(<span class="org-string">"----"</span>);
    }
  }
};
</pre>

<p>
It results in
</p><pre class="example">
===== data =====
key : Timezone Continent
typeof data[key] : string
data[key] : Europe
----
key : Offset
typeof data[key] : number
data[key] : 3600
----
key : DateTime
typeof data[key] : object
data[key] : Sun Feb 12 2012 09:46:52 GMT+0100 (CET)
----
key : Timezone
typeof data[key] : string
data[key] : Europe/Berlin
----
key : Time
typeof data[key] : object
data[key] : 09:46:52
----
key : Date
typeof data[key] : object
data[key] : Sun Feb 12 2012 00:00:00 GMT+0100 (CET)
----
key : Timezone City
typeof data[key] : string
data[key] : Berlin
</pre>

<p>The <code>Offset</code> looks off, doesn't it?.  That's because its unit is seconds.  My
time zone has an offset of
</p><pre class="example">
          3600 s * 1 min
3600 s =  -------------- = 60 min
                   60 s

          60 min * 1 h
60 min =  -------------- = 1 h .
                60 min
</pre>


<p>
If you compare this data with what is shown in <a href="#fig-plasmaengineexplorer">plasmaengineexplorer</a>,
then you'll notice it being exactly the same, except for the actual point in
time.  For Qt data types that don't have an builtin equivalent in Javascript we
get an object.
</p><ul>
<li><a href="http://doc.qt.nokia.com/4.7-snapshot/scripting.html#conversion-between-qtscript-and-c-types">Conversion between QtScript and C++ types</a>
</li>
</ul>

<p>Lets have a peek into what one of these converted Qt types has to offer
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"==== data ====="</span>);
    <span class="org-keyword">var</span> <span class="org-variable-name">dateTime</span> = data[<span class="org-string">"DateTime"</span>]
    print(<span class="org-string">'&lt;properties of data["DateTime"]'</span>);
    <span class="org-keyword">for</span>(<span class="org-keyword">var</span> <span class="org-variable-name">k</span> <span class="org-keyword">in</span> dateTime) {
      print(<span class="org-string">"key : "</span> + k);
      print(<span class="org-string">'typeof dateTime[key] : '</span> + <span class="org-keyword">typeof</span> dateTime[k]);
      print(<span class="org-string">'dateTime[key] : '</span> + dateTime[k]);
    }
    print(<span class="org-string">'&lt;/properties of data["DateTime"]'</span>);
  }
};
</pre>

<pre class="example">
==== data =====
&lt;properties of data["DateTime"]
&lt;/properties of data["DateTime"]
</pre>

<p>Nothing?  That is correct.  This shell around an C++ object only hands out you
a string representation of its value to Javascript.  Though they are not
showing up with the code above, these objects have the following methods
</p><ul>
<li><code>toString()</code>
</li>
<li><code>toLocaleString()</code>
</li>
<li><code>valueOf()</code>
</li>
<li><code>hasOwnProperty(V)</code>
</li>
<li><code>isPrototypeOf(V)</code>
</li>
<li><code>propertyIsEnumerable(V)</code>
</li>
</ul>

<p>The Qt docs just mention their existence
</p><ul>
<li><a href="http://doc.qt.nokia.com/4.7-snapshot/ecmascript.html">http://doc.qt.nokia.com/4.7-snapshot/ecmascript.html</a>
</li>
</ul>

<p>For real information head over to Mozilla
</p><ul>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object</a>
</li>
</ul>

<p>However, you probably only ever use <code>toString()</code>.
</p>


<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"==== data ====="</span>);
    <span class="org-keyword">var</span> <span class="org-variable-name">dateTime</span> = data[<span class="org-string">"DateTime"</span>]
    print(<span class="org-string">"typeof dateTime : "</span> + <span class="org-keyword">typeof</span> dateTime);
    print(<span class="org-string">"typeof dateTime.toString : "</span> + <span class="org-keyword">typeof</span> dateTime.toString);
    print(<span class="org-string">"typeof dateTime.toString() : "</span> + <span class="org-keyword">typeof</span> dateTime.toString());
    print(<span class="org-string">"dateTime.toString() : "</span> + dateTime.toString());
  }
};
</pre>

<pre class="example">
==== data =====
typeof dateTime : object
typeof dateTime.toString : function
typeof dateTime.toString() : string
dateTime.toString() : Sun Feb 12 2012 11:45:39 GMT+0100 (CET)
</pre>


</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> The <i>systemmonitor</i> date engine</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> CPU load</h3>
<div class="outline-text-3" id="text-5-1">


<div id="fig-cpu_total_load" class="figure">
<p><img src="images/cpu_total_load.png"  alt="images/cpu_total_load.png" /></p>
<p>systemmonitor : the system's total cpu load</p>
</div>




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(<span class="org-string">"==== data ====="</span>);
    <span class="org-keyword">for</span>(<span class="org-keyword">var</span> <span class="org-variable-name">k</span> <span class="org-keyword">in</span> data) {
      print(<span class="org-string">"key : "</span> + k);
      print(<span class="org-string">'data[key] : '</span> + data[k]);
      print(<span class="org-string">"---"</span>)
    }
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"cpu/system/TotalLoad"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
==== data =====
key : type
data[key] : float
---
==== data =====
key : units
data[key] : %
---
key : type
data[key] : float
---
key : value
data[key] : 1.503759
---
key : min
data[key] : 0
---
key : name
data[key] : CPU Total Load
---
key : max
data[key] : 100
</pre>





<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
NaN
4.834606%
0.502513%
1.012658%
</pre>





<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">No data aviable. God knows why</span>
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) {
      <span class="org-keyword">return</span>;
    }

    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
4.822335%
0.751880%
0.501253%
</pre>



<ul>
<li><a href="http://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/parseInt">http://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/parseInt</a>
</li>
</ul>




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">No data aviable. God knows why</span>
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) {
      <span class="org-keyword">return</span>;
    }

    print(parseInt(data[<span class="org-string">"value"</span>], 10) + data[<span class="org-string">"units"</span>]);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
5%
2%
0%
</pre>


</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Application memory</h3>
<div class="outline-text-3" id="text-5-2">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"mem/physical/application"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
connection established
main.js ends here
NaN
2077064KB
2079192KB
2079544KB
</pre>





<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) { <span class="org-keyword">return</span>; }
    print(parseInt(data[<span class="org-string">"value"</span>] / 1024, 10) + <span class="org-string">"MB"</span>);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
1934MB
1932MB
1932MB
</pre>

</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Wlan</h3>
<div class="outline-text-3" id="text-5-3">


</div>

<div id="outline-container-5-3-1" class="outline-4">
<h4 id="sec-5-3-1"><span class="section-number-4">5.3.1</span> Down rate</h4>
<div class="outline-text-4" id="text-5-3-1">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"network/interfaces/wlan0/receiver/data"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<p>
connection established
main.js ends here
NaN
89KB/s
103KB/s
105KB/s
</p>



<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) { <span class="org-keyword">return</span>; }
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
124KB/s
97KB/s
131KB/s
</pre>


</div>

</div>

<div id="outline-container-5-3-2" class="outline-4">
<h4 id="sec-5-3-2"><span class="section-number-4">5.3.2</span> Up rate</h4>
<div class="outline-text-4" id="text-5-3-2">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) { <span class="org-keyword">return</span>; }
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"network/interfaces/wlan0/transmitter/data"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);

</pre>

<pre class="example">
connection established
main.js ends here
5KB/s
6KB/s
6KB/s
</pre>


</div>

</div>

<div id="outline-container-5-3-3" class="outline-4">
<h4 id="sec-5-3-3"><span class="section-number-4">5.3.3</span> Joined data</h4>
<div class="outline-text-4" id="text-5-3-3">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = (<span class="org-keyword">function</span> () {
  <span class="org-keyword">var</span> <span class="org-variable-name">obj</span> = {}

  obj.sourceUp = <span class="org-string">"network/interfaces/wlan0/transmitter/data"</span>;
  obj.sourceDown = <span class="org-string">"network/interfaces/wlan0/receiver/data"</span>;
  obj.cache = {
    up: {value: <span class="org-string">"----"</span>, units: <span class="org-string">"KB/s"</span>},
    down: {value: <span class="org-string">"----"</span>, units: <span class="org-string">"KB/s"</span>}
  };

  obj.dataUpdated = <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) { <span class="org-keyword">return</span>; }

    <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: up and down tauchen</span>
    <span class="org-keyword">if</span> (name == <span class="org-constant">this</span>.sourceUp) {
      <span class="org-constant">this</span>.cache.up = data;
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> (name == <span class="org-constant">this</span>.sourceDown) {
      <span class="org-constant">this</span>.cache.down = data;
    }

    <span class="org-keyword">var</span> <span class="org-variable-name">msg</span> = <span class="org-string">"down: "</span> + <span class="org-constant">this</span>.cache.down[<span class="org-string">"value"</span>] + <span class="org-constant">this</span>.cache.down[<span class="org-string">"units"</span>];
    msg += <span class="org-string">" "</span>;
    msg += <span class="org-string">"up: "</span> + <span class="org-constant">this</span>.cache.up[<span class="org-string">"value"</span>] + <span class="org-constant">this</span>.cache.up[<span class="org-string">"units"</span>];
    print(msg);
  }

  <span class="org-keyword">return</span> obj;
})();


<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);

<span class="org-keyword">if</span> ( engine.connectSource(sink.sourceDown, sink, 1000) ) {
  print(<span class="org-string">"connection to '"</span> +  sink.sourceDown + <span class="org-string">"' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to '"</span> + sink.sourceDown + <span class="org-string">"' failed"</span>);
}

<span class="org-keyword">if</span> ( engine.connectSource(sink.sourceUp, sink, 1000) ) {
  print(<span class="org-string">"connection to '"</span> +  sink.sourceUp + <span class="org-string">"' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to '"</span> + sink.sourceUp + <span class="org-string">"' failed"</span>);
}


print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
connection to 'network/interfaces/wlan0/receiver/data' established
connection to 'network/interfaces/wlan0/transmitter/data' established
main.js ends here
down: ----KB/s up: 5KB/s
down: 105KB/s up: 5KB/s
down: 105KB/s up: 5KB/s
down: 91KB/s up: 5KB/s
down: 91KB/s up: 6KB/s
down: 147KB/s up: 6KB/s
</pre>


</div>
</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> Harddisk</h3>
<div class="outline-text-3" id="text-5-4">


</div>

<div id="outline-container-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> Read rate</h4>
<div class="outline-text-4" id="text-5-4-1">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    print(data[<span class="org-string">"value"</span>] + data[<span class="org-string">"units"</span>]);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"disk/sda_(8:0)/Rate/rblk"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
connection established
main.js ends here
NaN
0.000000KB/s
0.000000KB/s
0.000000KB/s
</pre>





<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">No data aviable. God knows why</span>
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) {
      <span class="org-keyword">return</span>;
    }

    print(parseInt(data[<span class="org-string">"value"</span>], 10) + data[<span class="org-string">"units"</span>]);
  }
};
</pre>

<pre class="example">
connection established
main.js ends here
0KB/s
0KB/s
0KB/s
</pre>


</div>

</div>

<div id="outline-container-5-4-2" class="outline-4">
<h4 id="sec-5-4-2"><span class="section-number-4">5.4.2</span> Write rate</h4>
<div class="outline-text-4" id="text-5-4-2">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = {
  <span class="org-function-name">dataUpdated</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">No data aviable. God knows why</span>
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) {
      <span class="org-keyword">return</span>;
    }

    print(parseInt(data[<span class="org-string">"value"</span>], 10) + data[<span class="org-string">"units"</span>]);
  }
};

<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);
<span class="org-keyword">if</span> ( engine.connectSource(<span class="org-string">"disk/sda_(8:0)/Rate/wblk"</span>, sink, 1000) ) {
  print(<span class="org-string">"connection established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt failed"</span>);
}

print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
connection established
main.js ends here
0KB/s
0KB/s
0KB/s
</pre>

</div>

</div>

<div id="outline-container-5-4-3" class="outline-4">
<h4 id="sec-5-4-3"><span class="section-number-4">5.4.3</span> Joined data</h4>
<div class="outline-text-4" id="text-5-4-3">




<pre class="src src-js"><span class="org-keyword">var</span> <span class="org-variable-name">sink</span> = (<span class="org-keyword">function</span> () {
  <span class="org-keyword">var</span> <span class="org-variable-name">obj</span> = {}

  obj.sourceRead = <span class="org-string">"disk/sda_(8:0)/Rate/wblk"</span>;
  obj.sourceWrite = <span class="org-string">"disk/sda_(8:0)/Rate/rblk"</span>;
  obj.cache = {
    read: {value: <span class="org-string">"----"</span>, units: <span class="org-string">"KB/s"</span>},
    write: {value: <span class="org-string">"----"</span>, units: <span class="org-string">"KB/s"</span>}
  };

  obj.dataUpdated = <span class="org-keyword">function</span> (<span class="org-variable-name">name</span>, <span class="org-variable-name">data</span>) {
    <span class="org-keyword">if</span> (!data[<span class="org-string">"value"</span>]) { <span class="org-keyword">return</span>; }

    <span class="org-keyword">if</span> (name == <span class="org-constant">this</span>.sourceRead) {
      <span class="org-constant">this</span>.cache.read = data;
      <span class="org-constant">this</span>.cache.read[<span class="org-string">"value"</span>] = parseInt(data[<span class="org-string">"value"</span>], 10);
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> (name == <span class="org-constant">this</span>.sourceWrite) {
      <span class="org-constant">this</span>.cache.write = data;
      <span class="org-constant">this</span>.cache.write[<span class="org-string">"value"</span>] = parseInt(data[<span class="org-string">"value"</span>], 10);
    }

    <span class="org-keyword">var</span> <span class="org-variable-name">msg</span> = <span class="org-string">"read: "</span> + <span class="org-constant">this</span>.cache.read[<span class="org-string">"value"</span>]
                       + <span class="org-constant">this</span>.cache.read[<span class="org-string">"units"</span>];
    msg += <span class="org-string">" "</span>;
    msg += <span class="org-string">"write: "</span> + <span class="org-constant">this</span>.cache.write[<span class="org-string">"value"</span>]
                     + <span class="org-constant">this</span>.cache.write[<span class="org-string">"units"</span>];
    print(msg);
  }

  <span class="org-keyword">return</span> obj;
})();


<span class="org-keyword">var</span> <span class="org-variable-name">engine</span> = dataEngine(<span class="org-string">"systemmonitor"</span>);

<span class="org-keyword">if</span> ( engine.connectSource(sink.sourceRead, sink, 1000) ) {
  print(<span class="org-string">"connection to '"</span> +  sink.sourceRead + <span class="org-string">"' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to '"</span> + sink.sourceRead + <span class="org-string">"' failed"</span>);
}

<span class="org-keyword">if</span> ( engine.connectSource(sink.sourceWrite, sink, 1000) ) {
  print(<span class="org-string">"connection to '"</span> +  sink.sourceWrite + <span class="org-string">"' established"</span>);
} <span class="org-keyword">else</span> {
  print(<span class="org-string">"connection attempt to '"</span> + sink.sourceWrite + <span class="org-string">"' failed"</span>);
}


print(<span class="org-string">"main.js ends here"</span>);
</pre>

<pre class="example">
connection to 'disk/sda_(8:0)/Rate/wblk' established
connection to 'disk/sda_(8:0)/Rate/rblk' established
main.js ends here
read: ----KB/s write: 0KB/s
read: 0KB/s write: 0KB/s
read: 0KB/s write: 0KB/s
</pre>



</div>
</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> UI</h2>
<div class="outline-text-2" id="text-6">

<p>The only two UI widget we'll use are a <a href="http://techbase.kde.org/Development/Tutorials/Plasma/JavaScript/API-UIElements#Label">Labels</a>, a <a href="http://techbase.kde.org/Development/Tutorials/Plasma/JavaScript/API-UIElements#LinearLayout">Layout</a> to arrange them and the
<a href="http://techbase.kde.org/Development/Tutorials/Plasma/JavaScript/API-PlasmoidObject">plasmoid</a> itself.
</p>

</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Hello plasmoid</h3>
<div class="outline-text-3" id="text-6-1">

<p>The applet itself is represented by a global object named <code>plasmoid</code>.  We gonna
take a look at what properties it has to offer
</p>


<pre class="src src-js"><span class="org-keyword">for</span>(<span class="org-keyword">var</span> <span class="org-variable-name">k</span> <span class="org-keyword">in</span> plasmoid) {
  print(k);
}
</pre>

<pre class="example">
objectName
aspectRatioMode
formFactor
location
currentActivity
shouldConserveResources
activeConfig
busy
backgroundHints
immutable
userConfiguring
apiVersion
status
rect
size
associatedApplication
layout
sender
destroyed(QObject*)
destroyed()
releaseVisualFocus()
configNeedsSaving()
formFactorChanged()
locationChanged()
contextChanged()
immutableChanged()
statusChanged()
gc()
formFactor()
aspectRatioMode()
setAspectRatioMode(AspectRatioMode)
setFailedToLaunch(bool,QString)
setFailedToLaunch(bool)
isBusy()
setBusy(bool)
backgroundHints()
setBackgroundHints(BackgroundHints)
setConfigurationRequired(bool,QString)
setConfigurationRequired(bool)
size()
rect()
setActionSeparator(QString)
setAction(QString,QString,QString,QString)
setAction(QString,QString,QString)
setAction(QString,QString)
removeAction(QString)
action(QString)
resize(qreal,qreal)
setMinimumSize(qreal,qreal)
setPreferredSize(qreal,qreal)
activeConfig()
setActiveConfig(QString)
readConfig(QString)
writeConfig(QString,QVariant)
file(QString)
file(QString,QString)
include(QString)
debug(QString)
findChild(QString)
extender()
downloadedFiles()
update(QRectF)
update()
listAddons
loadAddon
addEventListener
removeEventListener
hasExtension
__qt_scope__
</pre>

<p>From the number of properties alone you can tell that it must be important :P.
</p>
<p>
And it is.  The <code>P</code> in this graph
</p><pre class="example">
            P
           / \
          /   \
         /     \
        /       \
       O         O
      / \       /|\
     /   \     / | \
    O     O   O  O  O
</pre>

<p>represents <code>plasmoid</code>.  It is the root object of our applet.  All other elemets
in it are represented by an <code>O</code>.  If the applet is destroyed (by closing the
window of shutting plasma down) it starts a cleanup cascade.  It tells its
immediate children to kill their children and so on.
</p>
<p>
Besizes that role it has some methods that control the outer dimensions and
orientation of the applet.  For example
</p>


<pre class="src src-js">plasmoid.resize(300, 30);
</pre>


<div class="figure">
<p><img src="images/resize.png"  alt="images/resize.png" /></p>
<p>Resize</p>
</div>
<p>
The object graph for this applet is rather simple
</p><pre class="example">
            P
</pre>

<p>We gonna change that now.
</p>
</div>

</div>

<div id="outline-container-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Hello label</h3>
<div class="outline-text-3" id="text-6-2">

<p>This code
</p>


<pre class="src src-js">l = <span class="org-keyword">new</span> <span class="org-type">Label</span>(plasmoid) <span class="org-comment-delimiter">// </span><span class="org-comment">adds it as child of plasmoid</span>
l.text = <span class="org-string">"Hello World"</span>;
</pre>

<p>
puts a label <code>l</code> object into the graph
</p><pre class="example">
            P
            |
            |
            l
</pre>


<p>
The result
</p>
<div class="figure">
<p><img src="images/hello_label.png"  alt="images/hello_label.png" /></p>
<p>Hello label</p>
</div>
<p>
This looks broken, doesn't it?  A label on it's own doesn't what to do with
itself.
</p>
</div>

</div>

<div id="outline-container-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Hello layout</h3>
<div class="outline-text-3" id="text-6-3">

<p>The label needs some guidance, which will be delivered by an layout <code>L</code>
</p><pre class="example">
            P
            |
            |
            L
            |
            |
            l
</pre>




<pre class="src src-js">layout = <span class="org-keyword">new</span> <span class="org-type">LinearLayout</span>(plasmoid); <span class="org-comment-delimiter">// </span><span class="org-comment">add it as child of plasmoid</span>

l = <span class="org-keyword">new</span> <span class="org-type">Label</span>()
l.text = <span class="org-string">"Hello World"</span>;
layout.addItem(l); <span class="org-comment-delimiter">// </span><span class="org-comment">inserts it as cild of layout</span>
</pre>

<p>
The result is
</p>
<div class="figure">
<p><img src="images/hello_layout.png"  alt="images/hello_layout.png" /></p>
<p>Hello layout</p>
</div>
<p>
That looks a lot better.  However, I cheated.  You'll see prabably this:
</p>
<div class="figure">
<p><img src="images/hello_layout_err.png"  alt="images/hello_layout_err.png" /></p>
<p>Hello layout, err</p>
</div>
<p>
That is a lovely little bug that only occurs when the applet is run via
<i>plasmoidviewer</i>.  You can fix it buy resizing the plasmoid a tiny bit.
Actually, we can do that in the script itself
</p>


<pre class="src src-js">layout = <span class="org-keyword">new</span> <span class="org-type">LinearLayout</span>(plasmoid); <span class="org-comment-delimiter">// </span><span class="org-comment">add it as child of plasmoid</span>

l = <span class="org-keyword">new</span> <span class="org-type">Label</span>()
l.text = <span class="org-string">"Hello World"</span>;
layout.addItem(l); <span class="org-comment-delimiter">// </span><span class="org-comment">inserts it as cild of layout</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">ugly little hack to work around layout issue when using plasmoidviewer</span>
plasmoid.resize(201, 200)
plasmoid.resize(200, 200)
</pre>

<p>
I'll use that trick from now on, but won't actually include it in the code
listings.
</p>
</div>

</div>

<div id="outline-container-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> More labels!</h3>
<div class="outline-text-3" id="text-6-4">

<p>This code
</p>


<pre class="src src-js">layout = <span class="org-keyword">new</span> <span class="org-type">LinearLayout</span>(plasmoid); <span class="org-comment-delimiter">// </span><span class="org-comment">add it as child of plasmoid</span>

labels = [];
<span class="org-keyword">for</span>(<span class="org-keyword">var</span> <span class="org-variable-name">i</span> = 0; i &lt; 4; i++) {
  l = <span class="org-keyword">new</span> <span class="org-type">Label</span>()
  l.text = <span class="org-string">"l"</span> + i;
  layout.addItem(l); <span class="org-comment-delimiter">// </span><span class="org-comment">inserts it as cild of layout</span>

  labels.push(l); <span class="org-comment-delimiter">// </span><span class="org-comment">for later usage</span>
}
</pre>

<p>
builds this object graph
</p><pre class="example">
            P
            |
            L
            |
     o----o-----o---o
     |    |     |   |
    l0   l1    l2  l3
</pre>

<p>The resulting applet is
</p>
<div class="figure">
<p><img src="images/more_labels.png"  alt="images/more_labels.png" /></p>
<p>More labels</p>
</div>

<p>
TODO:
</p><ul>
<li>dummy layout with fake cpu, mem, wlan and sda values
</li>
<li>the real deal
</li>
</ul>


<p>
Idea: Maybe this is too much.  It might be a good idea to create seperate applets for
</p><ul>
<li>cpu
</li>
<li>mem
</li>
<li>mem and cpu
</li>
<li>wlan up
</li>
<li>wlan down
</li>
<li>wlan up and down
</li>
<li>sda read
</li>
<li>sda write
</li>
<li>sda read and write
</li>
</ul>

</div>
</div>
</div>
</div>

</body>
</html>
